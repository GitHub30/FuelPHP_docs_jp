<!doctype html>
<html lang="ja">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="./../../assets/css/combined.css">
	<link rel="shortcut icon" href="./../../favicon.ico" />
	<script src="http://www.google.com/jsapi" type="text/javascript"></script>
	<script type="text/javascript">
		var path = './../../';
		var class_prefix = "Upload::";
	</script>
	<script src="./../../assets/js/combined.js"></script>
	<title>Upload 使い方 - クラス - FuelPHP ドキュメント</title>
</head>
<body>
	<div id="container">
		<header id="header">
			<div class="table">
				<h1>
					<strong>FuelPHP, a PHP 5.3 Framework</strong>
					Documentation
				</h1>

				<form id="google_search">
					<p>
						<span id="search_clear">&nbsp;</span>
						<input type="submit" name="search_submit" id="search_submit" value="検索" />
						<input type="text" value="" id="search_input" name="search_input" />
					</p>
				</form>
			</div>
			<nav>

				<div class="clear"></div>
			</nav>
			<a href="#" id="toc_handle">目次</a>
			<div class="clear"></div>
		</header>

		<div id="cse">
			<div id="cse_point"></div>
			<div id="cse_content"></div>
		</div>

		<div id="main">

			<h2>Upload クラス</h2>

			<p>
				upload クラスは、アプリケーションにアップロードされたファイルを安全に処理する事ができます。
				アップロードを様々な方法でフィルタできます。目的のファイル名がどんな名前であるべきか、ファイルサイズやファイル名の長さでフィルタするか、等を定義できます。
			</p>

			<h3 id="uploaded_files_array">アップロードされたファイルの配列</h3>

			<p>アップロードされたファイルの情報はすべて、Upload クラス内の多次元配列に格納されます。
				ファイル毎に、以下のフィールドが定義された配列が作成されます。
			</p>

			<table class="config">
				<tbody>
					<tr class="header">
						<th>Key</th>
						<th>型</th>
						<th>説明</th>
					</tr>
					<tr>
						<th>field</th>
						<td>string</td>
						<td>
							ファイルアップロードに使用されたフォームのフィールド名。フォームフィールドが (多次元の) 配列の場合は、
							配列のキーをコロンで区切って追加します。
							フィールドが "field[a][b][]" の場合は "field:a:b:0" と格納されます。
						</td>
					</tr>
					<tr>
						<th>name</th>
						<td>string</td>
						<td>
							アップロードされたファイルの名前。
						</td>
					</tr>
					<tr>
						<th>type</th>
						<td>string</td>
						<td>
							アップロードされたファイルの Mime-type。ブラウザが定義したもの。
						</td>
					</tr>
					<tr>
						<th>mimetype</th>
						<td>string</td>
						<td>
							アップロードされたファイルの Mime-type。Upload クラスが判定したもの。
							最新の 'mime magic' ファイルがインストールされている必要があります。
							このファイルはすべての *nix プラットフォームにありますが、Windows プラットフォームにはありませんので、インストールが必要かもしれません。
							mime-type が判定できなかった場合は、'type' の値と同じになります。
						</td>
					</tr>
					<tr>
						<th>file</th>
						<td>string</td>
						<td>
							アップロードされたファイルの一時的な置き場所の完全修飾名。
						</td>
					</tr>
					<tr>
						<th>filename</th>
						<td>string</td>
						<td>
							アップロードされたファイルのファイル名 (basename)
						</td>
					</tr>
					<tr>
						<th>extension</th>
						<td>string</td>
						<td>
							アップロードされたファイルの拡張子
						</td>
					</tr>
					<tr>
						<th>size</th>
						<td>integer</td>
						<td>
							アップロードされたファイルのバイト数。
						</td>
					</tr>
					<tr>
						<th>error</th>
						<td>boolean</td>
						<td>
							アップロードに失敗した場合は true となり、errors 配列に原因が記述される。
						</td>
					</tr>
					<tr>
						<th>errors</th>
						<td>array</td>
						<td>
							配列を要素とする配列。それぞれ 'error' と 'message' の 2 つの値をもち、'error' にはエラーコード、'message' にはエラー文字列が記述される。
						</td>
					</tr>
				</tbody>
			</table>

			<p>
				mime-type は最も限定されたものになることに注意してください。たとえば、ブラウザが MS-Word document であると主張し、mime-type が
				 "application/octet-stream" と判定された場合、ブラウザの mime-type が使用されます。ブラウザの mime-type が間違っている場合や予想外だったとしてもです。
				例えば、Microsoft .xlsx file が、"application/zip" と判定されるかもしれません。
			</p>

			<p>
				save() メソッドを呼び出した後、この配列にはさらに 2 つのフィールドが追加されます。これらのフィールドは何が保存されたかの情報が記述されます。
			</p>

			<table class="config">
				<tbody>
					<tr class="header">
						<th>Key</th>
						<th>型</th>
						<th>説明</th>
					</tr>
					<tr>
						<th>saved_to</th>
						<td>string</td>
						<td>
							アップロードされたファイルが保存されている完全修飾パス。
						</td>
					</tr>
					<tr>
						<th>saved_as</th>
						<td>string</td>
						<td>
							保存されたファイルのファイル名。
						</td>
					</tr>
					<tr>
						<th>errors</th>
						<td>array</td>
						<td>
							errors 配列 (と error 真偽値) は、save() メソッド呼び出し後に更新され、ファイルを保存する時に発生したエラーを記述します。
						</td>
					</tr>
				</tbody>
			</table>

			<h3 id="error_constants">定義済みエラー定数</h3>

			<p>Upload クラスで定義されているエラー定数です。</p>

			<table class="config">
				<tbody>
					<tr class="header">
						<th>Name</th>
						<th>説明</th>
					</tr>
					<tr>
						<th>UPLOAD_ERR_OK</th>
						<td>
							エラーが発生せず、ファイルが正常にアップロードされた。
						</td>
					</tr>
					<tr>
						<th>UPLOAD_ERR_INI_SIZE</th>
						<td>
							ファイルサイズが php.ini の upload_max_filesize ディレクティブを超えた。
						</td>
					</tr>
					<tr>
						<th>UPLOAD_ERR_FORM_SIZE</th>
						<td>
							ファイルサイズが HTML フォームの MAX_FILE_SIZE ディレクティブを超えた。
						</td>
					</tr>
					<tr>
						<th>UPLOAD_ERR_PARTIAL</th>
						<td>
							ファイルが一部しかアップロードされなかった。
						</td>
					</tr>
					<tr>
						<th>UPLOAD_ERR_NO_FILE</th>
						<td>
							ファイルがアップロードされなかった。このエラーのあるエントリは、アップロードされたファイル一覧が処理されるときにフィルタリングされます。
						</td>
					</tr>
					<tr>
						<th>UPLOAD_ERR_NO_TMP_DIR</th>
						<td>
							一時フォルダが無い。
						</td>
					</tr>
					<tr>
						<th>UPLOAD_ERR_CANT_WRITE</th>
						<td>
							ディスクへの書き込みに失敗した。
						</td>
					</tr>
					<tr>
						<th>UPLOAD_ERR_EXTENSION</th>
						<td>
							PHP の拡張モジュールがファイルのアップロードを中止した。どの拡張モジュールがファイルアップロードを中止させたのかを突き止めることはできません。 読み込まれている拡張モジュールの一覧を phpinfo() で取得すれば参考になるでしょう。
						</td>
					</tr>
					<tr>
						<th>UPLOAD_ERR_MAX_SIZE</th>
						<td>
							ファイルサイズが、FuelPHP の設定で定義した最大サイズを超えた。
						</td>
					</tr>
					<tr>
						<th>UPLOAD_ERR_EXT_BLACKLISTED</th>
						<td>
							ファイル拡張子が、FuelPHP の設定で定義したブラックリストに合致した。
						</td>
					</tr>
					<tr>
						<th>UPLOAD_ERR_EXT_NOT_WHITELISTED</th>
						<td>
							ファイル拡張子が、FuelPHP の設定で定義したホワイトリストに無い。
						</td>
					</tr>
					<tr>
						<th>UPLOAD_ERR_TYPE_BLACKLISTED</th>
						<td>
							ファイル拡張子が、FuelPHP の設定で定義したファイルタイプのブラックリストに合致した。
						</td>
					</tr>
					<tr>
						<th>UPLOAD_ERR_TYPE_NOT_WHITELISTED</th>
						<td>
							ファイル拡張子が、FuelPHP の設定で定義したファイルタイプのホワイトリストに無い。
						</td>
					</tr>
					<tr>
						<th>UPLOAD_ERR_MIME_BLACKLISTED</th>
						<td>
							ファイル拡張子が、FuelPHP の設定で定義した mime-type のブラックリストに合致した。
						</td>
					</tr>
					<tr>
						<th>UPLOAD_ERR_MIME_NOT_WHITELISTED</th>
						<td>
							ファイル拡張子が、FuelPHP の設定で定義した mime-type のホワイトリストに無い。
						</td>
					</tr>
					<tr>
						<th>UPLOAD_ERR_MAX_FILENAME_LENGTH</th>
						<td>
							ファイル名が、FuelPHP の設定で定義したファイル名の長さを超えた。
						</td>
					</tr>
					<tr>
						<th>UPLOAD_ERR_MOVE_FAILED</th>
						<td>
							ファイルが、FuelPHP の設定で定義したパスに移動できなかった。パーミッションの問題の可能性があります。
						</td>
					</tr>
					<tr>
						<th>UPLOAD_ERR_DUPLICATE_FILE</th>
						<td>
							同名のファイルが既に存在するため、保存できなかった。
						</td>
					</tr>
				</tbody>
			</table>

			<p class="note">
				アップロード可能にするには、HTML &lt;form&gt; タグに <strong>enctype="multipart/form-data"</strong> が含まれていなければなりません。またフォームには
				タイプが "file" のフィールドが最低 1 つ含まれていなければなりません。そうしないと、アップロードは失敗し、Upload::process が例外を投げます。
			</p>

			<h3 id="usage_example">Usage example</h3>
			<pre class="php"><code>// Custom configuration for this upload
$config = array(
	'path' => DOCROOT.'files',
	'randomize' => true,
	'ext_whitelist' => array('img', 'jpg', 'jpeg', 'gif', 'png'),
);

// process the uploaded files in $_FILES
Upload::process($config);

// if there are any valid files
if (Upload::is_valid())
{
	// save them according to the config
	Upload::save();

	// call a model method to update the database
	Model_Uploads::add(Upload::get_files());
}

// and process any errors
foreach (Upload::get_errors() as $file)
{
	// $file is an array with all file information,
	// $file['errors'] contains an array of all error occurred
	// each array element is an an array containing 'error' and 'message'
}
</code></pre>

			<article>
				<h4 class="method" id="method_is_valid">is_valid()</h4>
				<p>The <strong>is_valid</strong> method can be used to check if there are any uploaded files present that have passed the upload validation.</p>
				<table class="method">
					<tbody>
					<tr>
						<th class="legend">静的</th>
						<td>はい</td>
					</tr>
					<tr>
						<th>パラメータ</th>
						<td>None</td>
					</tr>
					<tr>
						<th>返り値</th>
						<td>boolean - true if validated files exist, false if not.</td>
					</tr>
					<tr>
						<th>例</th>
						<td>
							<pre class="php"><code>// do we have any uploaded files to save?
if (Upload::is_valid())
{
	Upload::save();
}
</code></pre>
						</td>
					</tr>
					</tbody>
				</table>
			</article>

			<article>
				<h4 class="method" id="method_get_files">get_files($index = null)</h4>
				<p>The <strong>get_files</strong> method returns a multi-dimensional array with all files uploaded that have an error value of <strong>false</strong>.</p>
				<table class="method">
					<tbody>
					<tr>
						<th class="legend">静的</th>
						<td>はい</td>
					</tr>
					<tr>
						<th>パラメータ</th>
						<td>
							<table class="parameters">
								<tr>
									<th>パラメータ</th>
									<th>デフォルト</th>
									<th class="description">説明</th>
								</tr>
								<tr>
									<th><kbd>$index</kbd></th>
									<td><i>optional</i></td>
									<td>index number of the file in the uploaded files array, or the name of a form field. If not specified, an array with all validated files is returned.
									If the index number is invalid, or if the index refers to a file with an error status of <strong>true</strong>, an exception is thrown.</td>
								</tr>
							</table>
						</td>
					</tr>
					<tr>
						<th>返り値</th>
						<td>array</td>
					</tr>
					<tr>
						<th>例</th>
						<td>
							<pre class="php"><code>// get the list of successfully uploaded files
foreach(Upload::get_files() as $file)
{
	// do something with the file info
}

// get the first uploaded file by index
if ( ! Upload::get_files(0))
{
	// first uploaded file was not succesfully uploaded
}
</code></pre>
						</td>
					</tr>
					</tbody>
				</table>
			</article>

			<article>
				<h4 class="method" id="method_get_errors">get_errors($index = null)</h4>
				<p>The <strong>get_errors</strong> method returns a multi-dimensional array with all files uploaded that have an error status of <strong>true</strong>.</p>
				<table class="method">
					<tbody>
					<tr>
						<th class="legend">静的</th>
						<td>はい</td>
					</tr>
					<tr>
						<th>パラメータ</th>
						<td>
							<table class="parameters">
								<tr>
									<th>パラメータ</th>
									<th>デフォルト</th>
									<th class="description">説明</th>
								</tr>
								<tr>
									<th><kbd>$index</kbd></th>
									<td><i>optional</i></td>
									<td>index number of the file in the uploaded files array or the name of a form field. If not specified, an array with all invalid files is returned.
									If the index number is invalid, or if the index refers to a file with an error status of <strong>false</strong>, an exception is thrown.</td>
								</tr>
							</table>
						</td>
					</tr>
					<tr>
						<th>返り値</th>
						<td>array</td>
					</tr>
					<tr>
						<th>例</th>
						<td>
							<pre class="php"><code>// get the list of uploaded files with errors
foreach(Upload::get_errors() as $file)
{
	// do something with the file info
}

// get the first uploaded file by field name
if (Upload::get_errors('new_image'))
{
	// there was an error uploading the file for the form field 'new_image'
	// defined as &lt;input type="file" name="new_image" /&gt;
}
</code></pre>
						</td>
					</tr>
					</tbody>
				</table>
				<p class="note">
					Note that all upload fields in your form are submitted, even if they are optional. For fields that are left empty, the
					uploaded files array will have an empty file entry, with an error code of <strong>Upload::UPLOAD_ERR_NO_FILE</strong>. When processing
					errors, check the error code first, before trying to use any of the other fields in the returned array.</p>
			</article>

			<article>
				<h4 class="method" id="method_register">register($event, $callback)</h4>
				<p>
					The <strong>register</strong> method allows you to register callbacks for specific upload events,
					and allow you to add your own code to the <strong>process()</strong> and <strong>save()</strong> methods.
				</p>
				<table class="method">
					<tbody>
					<tr>
						<th class="legend">静的</th>
						<td>はい</td>
					</tr>
					<tr>
						<th>パラメータ</th>
						<td>
							<table class="parameters">
								<tr>
									<th>パラメータ</th>
									<th>デフォルト</th>
									<th class="description">説明</th>
								</tr>
								<tr>
									<th><kbd>$event</kbd></th>
									<td><i>必須</i></td>
									<td>name of the callback event you want to register. Valid names are 'validate', 'before' and 'after'.</td>
								</tr>
								<tr>
									<th><kbd>$callback</kbd></th>
									<td><i>必須</i></td>
									<td>Valid PHP callback function. This can be a function, a dynamic or static method, or a closure.</td>
								</tr>
							</table>
						</td>
					</tr>
					<tr>
						<th>返り値</th>
						<td>boolean - true if the callback was registered, false if the registration failed.</td>
					</tr>
					<tr>
						<th>例</th>
						<td>
							<pre class="php"><code>// register a before callback using a closure
Upload::register('before', function (&amp;$file) {
	if ($file['error'] == Upload::UPLOAD_ERR_OK)
	{
		switch($file['extension'])
		{
			case "jpg":
			case "png":
			case "gif":
				// store these in the images subdirectory
				$file['file'] .= 'images/';
			break;

			case "css":
				// store these in the css subdirectory
				$file['file'] .= 'css/';
			break;

			case "js":
				// store these in the javascript subdirectory
				$file['file'] .= 'js/';
			break;

			default:
				// don't modify the path for all others
		}
	}
});
</code></pre>
						</td>
					</tr>
					</tbody>
				</table>
				<p>
					If you want to use a 'validate' callback, be sure to register it before you call Upload::process().
					If you have used the 'auto_process' configuration setting, Upload::process() will be called as soon as you use the Upload class,
					which means you can't use this setting if you want to define callbacks at runtime.
				</p>
				<p>
					The callback will receive a FuelPHP\Upload\File object as parameter. The entry is passed by reference, which allows
					the callback function to modify the entries of the array. You can access it as an array for backward compatibility
					reasons, but if migrate your application a version &lt; 1.6 to 1.6+, check the value passed to your callbacks, as
					not all attributes are named the same as in pre-1.6.<br />
					If the callback function returns an integer, it is assumed to be an update of the uploaded file's error code.
					All other return values are ignored.
				</p>

				<p class="note">
					<strong>Note:</strong> if you alter the contents of the <strong>$file</strong> array in your callback, you have to make sure that the
					information is still valid, as the Upload class won't perform its checks again. The only exception to this rule is the '<strong>file</strong>' path,
					which will be checked and created if required after the callback has been executed.
				</p>
			</article>

			<article>
				<h4 class="method" id="method_process">process($config = array())</h4>
				<p>
					The <strong>process</strong> method processes the information about all uploaded files,
					normalizes the different permutations of form field names that can be used,
					fetches additional information about the file and its mimetype,
					and validates the file.
				</p>
				<table class="method">
					<tbody>
					<tr>
						<th class="legend">静的</th>
						<td>はい</td>
					</tr>
					<tr>
						<th>パラメータ</th>
						<td>
							<table class="parameters">
								<tr>
									<th>パラメータ</th>
									<th>デフォルト</th>
									<th class="description">説明</th>
								</tr>
								<tr>
									<th><kbd>$config</kbd></th>
									<td><i>optional</i></td>
									<td>array of configuration items, so you can override the settings defined in the configuration file.</td>
								</tr>
							</table>
						</td>
					</tr>
					<tr>
						<th>返り値</th>
						<td>void</td>
					</tr>
					<tr>
						<th>Throws</th>
						<td>FuelException, when no file upload attempt could be detected (i.e. form without "Enctype" or input field of type="file")</td>
					</tr>
					<tr>
						<th>Example</th>
						<td>
							<pre class="php"><code>// process the uploaded files
// set the max size to 10Kb, and allow overwrites of duplicate files
Upload::process(array(
	'max_size'    => 10240,
	'auto_rename' => false,
	'overwrite'   => true
));
</code></pre>
						</td>
					</tr>
					</tbody>
				</table>
				<p class="note">If you intend to use this method, disable <strong>auto_process</strong> in the config, to avoid processing the uploaded files twice!</p>
			</article>

			<article>
				<h4 class="method" id="method_save">save( ... )</h4>
				<p>The <strong>save</strong> method saves all validated files uploaded to the path specified.</p>
				<table class="method">
					<tbody>
					<tr>
						<th class="legend">静的</th>
						<td>はい</td>
					</tr>
					<tr>
						<th>パラメータ</th>
						<td>
							<table class="parameters">
								<tr>
									<th>パラメータ</th>
									<th>デフォルト</th>
									<th class="description">説明</th>
								</tr>
								<tr>
									<th><kbd>$integer</kbd></th>
									<td><i>optional</i></td>
									<td>Key of the files array returned by <strong>get_files()</strong>. This allows you to save an individual file from a set of uploaded files.</td>
								</tr>
								<tr>
									<th><kbd>$array</kbd></th>
									<td><i>optional</i></td>
									<td>Array of keys of the files array returned by <strong>get_files()</strong>. This allows you to save a selection of files from a set of uploaded files.</td>
								</tr>
								<tr>
									<th><kbd>$string</kbd></th>
									<td><i>optional</i></td>
									<td>The path the files should be saved to. This overrides the path specified in the configuration, or passed in the $config array when the <strong>process()</strong> method was called.</td>
								</tr>
							</table>
							<br />
							Note that the order in which these parameters are given is not relevant, and all of them are optional. But either use $integer or $array, and not both. If you do, the last one specified will be used.
						</td>
					</tr>
					<tr>
						<th>返り値</th>
						<td>void</td>
					</tr>
					<tr>
						<th>例</th>
						<td>
							<pre class="php"><code>// save all validated files
Upload::save();

// save only the first uploaded file
Upload::save(0);

// save the first, second and fourth uploaded file
Upload::save(0, 1, 3);

// save all validated files, and to an alternate location
$arr = Upload::get_files();
Upload::save(DOCROOT.'assets', array_keys($arr));

// process any errors on these files
foreach (Upload::get_errors() as $key => $file)
{
	// process the errors here
}
</code></pre>
						</td>
					</tr>
					</tbody>
				</table>
			</article>

		</div>

		<footer>
			<p>
				&copy; FuelPHP Development Team 2010-2014 - <a href="http://fuelphp.com">FuelPHP</a> is released under the MIT license.
[ <a href="https://github.com/fuel/docs/commits/1.8/develop/classes/upload/usage.html">原文コミット履歴</a> | <a href="https://github.com/NEKOGET/FuelPHP_docs_jp/commits/1.8/develop_japanese/classes/upload/usage.html">翻訳コミット履歴</a> | <a href="https://github.com/NEKOGET/FuelPHP_docs_jp/blob/1.8/develop_japanese/classes/upload/usage.html">GitHubで修正</a> ]
			</p>
		</footer>
	</div>
</body>
</html>
